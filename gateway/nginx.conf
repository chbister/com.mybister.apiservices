events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # Allow large file uploads
    client_max_body_size 500M;
    proxy_read_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;

    # Docker DNS resolver
    resolver 127.0.0.11 valid=30s;

    server {
        listen 80;

        location /health {
            return 200 '{"status":"ok", "service":"gateway"}';
            add_header Content-Type application/json;
        }

        # Routing for tiny model
        location ~ ^/asr-tiny/(.*)$ {
            set $target asr-tiny-link;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            # Disable buffering to ensure 202 Accepted is sent immediately
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_http_version 1.1;
        }

        # Routing for small model
        location ~ ^/asr-small/(.*)$ {
            set $target asr-small-link;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_buffering off;
            proxy_request_buffering off;
            proxy_http_version 1.1;
        }

        # Routing for medium model
        location ~ ^/asr-medium/(.*)$ {
            set $target asr-medium-link;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_buffering off;
            proxy_request_buffering off;
            proxy_http_version 1.1;
        }

        # Routing for large model
        location ~ ^/asr-large/(.*)$ {
            set $target asr-large-link;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_buffering off;
            proxy_request_buffering off;
            proxy_http_version 1.1;
        }
        
        # Sentiment service routing
        location ~ ^/sentiment/(.*)$ {
            set $target sentiment;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
        }

        # Barcode service routing
        location ~ ^/barcode/(.*)$ {
            set $target barcode;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
        }

        # Emotion service routing
        location ~ ^/emotion/(.*)$ {
            set $target emotion;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
        }

        # Emotion variants routing
        location ~ ^/emotion-nuance/(.*)$ {
            set $target emotion-nuance;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
        }
        location ~ ^/emotion-vibe/(.*)$ {
            set $target emotion-vibe;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
        }
        location ~ ^/emotion-state/(.*)$ {
            set $target emotion-state;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
        }

        # Processor service routing
        location ~ ^/processor/(.*)$ {
            set $target processor;
            proxy_pass http://$target:8000/$1$is_args$args;
            proxy_set_header Host $host;
        }
    }
}
