x-common-env: &common-env
  HF_TOKEN: "${HF_TOKEN:-}"
  CALLBACK_AUTH_SECRET: "${CALLBACK_AUTH_SECRET:-}"
  REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
  SSL_CERT_FILE: /etc/ssl/certs/ca-certificates.crt

x-asr-env: &asr-env
  <<: *common-env
  ASR_COMPUTE_TYPE: "int8"
  ASR_DEFAULT_LANGUAGE: "auto"
  ASR_ASYNC_THRESHOLD: "300"
  ASR_JOBS_DIR: "/srv/jobs"
  UVICORN_HOST: "0.0.0.0"
  UVICORN_PORT: "8000"
  UVICORN_WORKERS: "2"
  OMP_NUM_THREADS: "1"
  CT2_NUM_THREADS: "1"

x-asr-base: &asr-base
  build:
    context: ./asr-service
  image: asr-service:local
  environment:
    <<: *asr-env
  volumes:
    - hf_cache:/root/.cache/huggingface
    - ct2_cache:/root/.cache/ctranslate2
    - asr_jobs:/srv/jobs

services:
  # --- PRODUCTION SERVICES (Profile: prod) ---
  asr-tiny:
    <<: *asr-base
    expose:
      - "8000"
    environment:
      <<: *asr-env
      ASR_MODEL_SIZE: "tiny"
      UVICORN_LOG_LEVEL: "info"
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - asr-tiny-link

  asr-small:
    <<: *asr-base
    expose:
      - "8000"
    environment:
      <<: *asr-env
      ASR_MODEL_SIZE: "small"
      UVICORN_LOG_LEVEL: "info"
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - asr-small-link

  asr-medium:
    <<: *asr-base
    expose:
      - "8000"
    environment:
      <<: *asr-env
      ASR_MODEL_SIZE: "medium"
      UVICORN_LOG_LEVEL: "info"
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - asr-medium-link

  asr-large:
    <<: *asr-base
    expose:
      - "8000"
    environment:
      <<: *asr-env
      ASR_MODEL_SIZE: "large-v3"
      UVICORN_LOG_LEVEL: "info"
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - asr-large-link

  # --- DEVELOPMENT SERVICES (Profile: dev) ---
  asr-tiny-dev:
    <<: *asr-base
    expose:
      - "8000"
    environment:
      <<: *asr-env
      ASR_MODEL_SIZE: "tiny"
      UVICORN_RELOAD: "1"
      UVICORN_LOG_LEVEL: "debug"
    volumes:
      - ./asr-service/app:/srv/app:rw
      - hf_cache:/root/.cache/huggingface
      - ct2_cache:/root/.cache/ctranslate2
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - asr-tiny-link

  asr-small-dev:
    <<: *asr-base
    expose:
      - "8000"
    environment:
      <<: *asr-env
      ASR_MODEL_SIZE: "small"
      UVICORN_RELOAD: "1"
      UVICORN_LOG_LEVEL: "debug"
    volumes:
      - ./asr-service/app:/srv/app:rw
      - hf_cache:/root/.cache/huggingface
      - ct2_cache:/root/.cache/ctranslate2
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - asr-small-link

  asr-medium-dev:
    <<: *asr-base
    expose:
      - "8000"
    environment:
      <<: *asr-env
      ASR_MODEL_SIZE: "medium"
      UVICORN_RELOAD: "1"
      UVICORN_LOG_LEVEL: "debug"
    volumes:
      - ./asr-service/app:/srv/app:rw
      - hf_cache:/root/.cache/huggingface
      - ct2_cache:/root/.cache/ctranslate2
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - asr-medium-link

  asr-large-dev:
    <<: *asr-base
    expose:
      - "8000"
    environment:
      <<: *asr-env
      ASR_MODEL_SIZE: "large-v3"
      UVICORN_RELOAD: "1"
      UVICORN_LOG_LEVEL: "debug"
    volumes:
      - ./asr-service/app:/srv/app:rw
      - hf_cache:/root/.cache/huggingface
      - ct2_cache:/root/.cache/ctranslate2
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - asr-large-link

  diarization:
    build:
      context: ./diarization-service
    image: diarization-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      DIARIZATION_MAX_ANALYZE_SEC: 120
      DIARIZATION_MIN_SPEAKER_SEC: 10
      DIARIZATION_MIN_SPEAKER_SHARE: 0.15
    volumes:
      - hf_cache:/root/.cache/huggingface
      - ct2_cache:/root/.cache/ctranslate2
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - diarization-link

  diarization-dev:
    image: diarization-service:local
    expose:
      - "8000"
    environment:
      <<: *asr-env
      UVICORN_RELOAD: "1"
      UVICORN_LOG_LEVEL: "debug"
      DIARIZATION_MAX_ANALYZE_SEC: 120
      DIARIZATION_MIN_SPEAKER_SEC: 10
      DIARIZATION_MIN_SPEAKER_SHARE: 0.15
    volumes:
      - ./diarization-service/app:/srv/app:rw
      - hf_cache:/root/.cache/huggingface
      - ct2_cache:/root/.cache/ctranslate2
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - diarization-link

  gateway:
    image: nginx:alpine
    expose:
      - "80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - asr-large
      - asr-medium
      - asr-small
      - asr-tiny
      - barcode
      - diarization
      - emotion
      - emotion-hate
      - emotion-nuance
      - emotion-state
      - emotion-vibe
      - metadata
      - processor
      - sentiment
    profiles: [ "prod" ]
    networks:
      - edge
      - app

  gateway-dev:
    image: nginx:alpine
    expose:
      - "80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - asr-large-dev
      - asr-medium-dev
      - asr-small-dev
      - asr-tiny-dev
      - barcode-dev
      - callback-tester-dev
      - diarization-dev
      - emotion-dev
      - emotion-hate-dev
      - emotion-nuance-dev
      - emotion-state-dev
      - emotion-vibe-dev
      - metadata-dev
      - processor-dev
      - sentiment-dev
    profiles: [ "dev" ]
    networks:
      - edge
      - app

  barcode:
    build:
      context: ./barcode-service
    image: barcode-service:local
    expose:
      - "8000"
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - barcode

  barcode-dev:
    image: barcode-service:local
    expose:
      - "8000"
    volumes:
      - ./barcode-service/app:/srv/app:rw
    environment:
      <<: *common-env
      UVICORN_RELOAD: "1"
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - barcode

  sentiment:
    build:
      context: ./sentiment-service
    image: sentiment-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      SENTIMENT_MODEL_ID: "cardiffnlp/twitter-xlm-roberta-base-sentiment"
    restart: unless-stopped
    volumes:
      - hf_cache:/root/.cache
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - sentiment

  sentiment-dev:
    image: sentiment-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      SENTIMENT_MODEL_ID: "cardiffnlp/twitter-xlm-roberta-base-sentiment"
      UVICORN_RELOAD: "1"
    volumes:
      - ./sentiment-service/app:/srv/app:rw
      - hf_cache:/root/.cache
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - sentiment

  emotion:
    build:
      context: ./emotion-service
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      EMOTION_MODEL_ID: "lxyuan/distilbert-base-multilingual-cased-sentiments-student"
    volumes:
      - hf_cache:/root/.cache
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - emotion

  emotion-dev:
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      EMOTION_MODEL_ID: "lxyuan/distilbert-base-multilingual-cased-sentiments-student"
      UVICORN_RELOAD: "1"
    volumes:
      - ./emotion-service/app:/srv/app:rw
      - hf_cache:/root/.cache
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - emotion

  # --- EMOTION MODEL VARIANTS (Profile: prod) ---
  emotion-nuance:
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      EMOTION_MODEL_ID: "SamLowe/roberta-base-go_emotions"
    volumes:
      - hf_cache:/root/.cache
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - emotion-nuance

  emotion-vibe:
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      EMOTION_MODEL_ID: "nlptown/bert-base-multilingual-uncased-sentiment" # Excellent for vibe/stars across languages
    volumes:
      - hf_cache:/root/.cache
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - emotion-vibe

  emotion-state:
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      EMOTION_MODEL_ID: "j-hartmann/emotion-english-distilroberta-base" # 7 core emotions
    volumes:
      - hf_cache:/root/.cache
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - emotion-state

  # --- EMOTION MODEL VARIANTS (Profile: dev) ---
  emotion-nuance-dev:
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      EMOTION_MODEL_ID: "SamLowe/roberta-base-go_emotions"
      UVICORN_RELOAD: "1"
    volumes:
      - ./emotion-service/app:/srv/app:rw
      - hf_cache:/root/.cache
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - emotion-nuance

  emotion-vibe-dev:
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      EMOTION_MODEL_ID: "nlptown/bert-base-multilingual-uncased-sentiment"
      UVICORN_RELOAD: "1"
    volumes:
      - ./emotion-service/app:/srv/app:rw
      - hf_cache:/root/.cache
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - emotion-vibe

  emotion-state-dev:
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      #EMOTION_MODEL_ID: "j-hartmann/emotion-english-distilroberta-base"
      #EMOTION_MODEL_ID: "j-hartmann/emotion-multilingual-distilroberta-base"
      EMOTION_MODEL_ID: "ChrisLalk/German-Emotions"
      UVICORN_RELOAD: "1"
    volumes:
      - ./emotion-service/app:/srv/app:rw
      - hf_cache:/root/.cache
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - emotion-state

  emotion-hate:
    build:
      context: ./emotion-service
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      EMOTION_MODEL_ID: "cardiffnlp/twitter-roberta-base-hate"
    volumes:
      - hf_cache:/root/.cache
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - emotion-hate

  emotion-hate-dev:
    image: emotion-service:local
    expose:
      - "8000"
    environment:
      <<: *common-env
      EMOTION_MODEL_ID: "cardiffnlp/twitter-roberta-base-hate"
      UVICORN_RELOAD: "1"
    volumes:
      - ./emotion-service/app:/srv/app:rw
      - hf_cache:/root/.cache
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - emotion-hate

  processor:
    build:
      context: ./processor-service
    image: processor-service:local
    expose:
      - "8000"
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - processor

  processor-dev:
    image: processor-service:local
    expose:
      - "8000"
    volumes:
      - ./processor-service/app:/srv/app:rw
    environment:
      <<: *common-env
      UVICORN_RELOAD: "1"
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - processor

  callback-tester:
    build:
      context: ./callback-tester
    image: callback-tester:local
    expose:
      - "8000"
    volumes:
      - callback_data:/srv/callbacks
    profiles: [ "prod" ]
    networks:
      app:
        aliases:
          - callback-tester

  callback-tester-dev:
    image: callback-tester:local
    expose:
      - "8000"
    volumes:
      - ./callback-tester/app:/srv/app:rw
      - callback_data:/srv/callbacks
    environment:
      <<: *common-env
      UVICORN_RELOAD: "1"
    profiles: [ "dev" ]
    networks:
      app:
        aliases:
          - callback-tester

  metadata:
    build:
      context: ./metadata-service
    image: metadata:local
    environment:
      <<: *common-env
      MAX_DOWNLOAD_BYTES: 2097152000
      DOWNLOAD_TIMEOUT_S: 30
    profiles: [ "prod" ]
    expose:
      - "8000"
    networks:
      proxy-network:
        aliases:
          - metadata
  metadata-dev:
    image: metadata:local
    environment:
      <<: *common-env
      MAX_DOWNLOAD_BYTES: 2097152000
      DOWNLOAD_TIMEOUT_S: 30
      UVICORN_RELOAD: 1
    profiles: [ "dev" ]
    expose:
      - "8000"
    volumes:
      - ./metadata-service/app:/srv/app:rw
    networks:
      app:
        aliases:
          - metadata

volumes:
  hf_cache:
  ct2_cache:
  asr_jobs:
  callback_data:
networks:
  edge:
    external: true
    name: ${EDGE_NETWORK_NAME:-dev-shared-network}
  app: # internal-to-this-compose network (bridge)
    driver: bridge
